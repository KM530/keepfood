# 智能食物保鲜管家项目启动指南

## 环境要求

### 系统环境
- Windows 10/11
- Node.js 18+ 
- Python 3.8+
- MySQL 8.0+

### 开发工具
- Git
- VS Code (推荐)
- MySQL Workbench 或其他数据库管理工具

## 数据库准备

### 1. 创建数据库
在MySQL中执行以下SQL命令：
```sql
CREATE DATABASE food_manager CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

### 2. 创建数据库用户（可选）
```sql
CREATE USER 'food_user'@'localhost' IDENTIFIED BY 'your_password';
GRANT ALL PRIVILEGES ON food_manager.* TO 'food_user'@'localhost';
FLUSH PRIVILEGES;
```

## 后端启动步骤

### 1. 进入后端目录
```bash
cd foodback
```

### 2. 创建虚拟环境
```bash
python -m venv venv
```

### 3. 激活虚拟环境
```bash
# Windows
venv\Scripts\activate
```

### 4. 安装依赖
```bash
pip install -r requirements/dev.txt
```

### 5. 配置环境变量
编辑 `.env` 文件，修改数据库连接信息：
```bash
DATABASE_URL=mysql+pymysql://root:your_password@localhost:3306/food_manager
```
**注意：将 `your_password` 替换为你的MySQL密码**

### 6. 测试导入（可选）
先测试Python模块导入是否正常：
```bash
python test_import.py
```

### 7. 初始化数据库
```bash
flask db init
flask db migrate -m "Initial migration"
flask db upgrade
```

### 8. 启动后端服务

#### 方式1：使用 Pipenv (推荐)
```bash
# 安装依赖
pipenv install --dev

# 测试导入
pipenv run python test_simple.py

# 数据库迁移 (仅首次或有模型变更时)
pipenv run flask db migrate -m "Auto migration"
pipenv run flask db upgrade

# 启动服务
pipenv run flask run --host=0.0.0.0 --port=5000

# 或者使用批处理脚本
start_backend_pipenv.bat
```

#### 方式2：使用虚拟环境
```bash
# 激活虚拟环境
venv\Scripts\activate

# 启动服务
flask run --host=0.0.0.0 --port=5001

# 或者使用批处理脚本
start_backend.bat
```

#### 方式3：直接启动
```bash
python start_dev.py
```

后端服务将在 `http://localhost:5000` 启动

## 前端启动步骤

### 1. 进入前端目录
```bash
cd food
```

### 2. 安装依赖
```bash
npm install
```

### 3. 启动开发服务器
```bash
# 启动Expo开发服务器
npm start

# 或者直接启动Web版本
npm run web
```

### 4. 访问应用
- **Web版本**: http://localhost:8081
- **移动端**: 使用Expo Go应用扫描二维码

## 验证安装

### 1. 检查后端API
访问 `http://localhost:5000/api/auth/health` 应该返回健康检查信息

### 2. 检查前端页面
访问 `http://localhost:8081` 应该看到登录页面

### 3. 测试完整流程
1. 在前端注册新用户
2. 登录系统
3. 添加一个食物项目
4. 查看食物列表

## 常见问题解决

### 导入错误问题
如果遇到 `ImportError: cannot import name 'flash_errors'` 或类似错误：
```bash
# 1. 确保虚拟环境已激活
venv\Scripts\activate

# 2. 运行导入测试
python test_import.py

# 3. 如果测试失败，重新安装依赖
pip install -r requirements/dev.txt --force-reinstall
```

### Flask-Migrate问题
如果遇到 `Error: No such command 'db'`：
```bash
# 确保Flask-Migrate已安装
pip install Flask-Migrate

# 检查扩展是否正确注册
python -c "from foodback.extensions import migrate; print('Migrate OK')"
```

### 数据库连接问题
```bash
# 检查MySQL服务是否启动
net start mysql

# 测试数据库连接
mysql -u root -p
```

### Python依赖问题
```bash
# 升级pip
python -m pip install --upgrade pip

# 重新安装依赖
pip install -r requirements/dev.txt --force-reinstall
```

### Node.js依赖问题
```bash
# 方式1：使用重置脚本（推荐）
cd food
reset_and_install.bat

# 方式2：手动清理
npm cache clean --force
rmdir /s /q node_modules
rmdir /s /q .expo
npm install
npx expo install --fix
```

### 前端模块解析错误
如果遇到 "Unable to resolve" 错误：
```bash
cd food
# 清理并重新安装所有依赖
reset_and_install.bat
# 然后使用Web专用启动脚本
start_web.bat
```

### Android配置问题
如果遇到 "Required property 'android.package' is not found"：
- 已在app.json中添加了android.package配置
- 使用Web版本开发: `npm run web`

### 端口占用问题
```bash
# 查看端口占用
netstat -ano | findstr :5000
netstat -ano | findstr :8081

# 杀死占用进程
taskkill /PID <PID> /F
```

## 开发调试

### 后端调试
- Flask自动重载已启用
- 日志级别设置为DEBUG
- 可以使用VS Code的Python调试器

### 前端调试
- 支持热重载
- 可以使用浏览器开发者工具
- React DevTools扩展

### API测试
推荐使用以下工具测试API：
- Postman
- Thunder Client (VS Code扩展)
- curl命令

## 项目结构

```
kevin/
├── food/              # 前端React Native项目
│   ├── app/          # 页面组件 (expo-router)
│   ├── components/   # 可复用组件
│   ├── hooks/        # 自定义Hooks
│   ├── lib/          # 工具库和API客户端
│   └── types/        # TypeScript类型定义
└── foodback/         # 后端Flask项目
    ├── foodback/     # 主应用包
    │   ├── api/      # API蓝图
    │   ├── auth/     # 认证模块
    │   ├── models/   # 数据模型
    │   ├── tasks/    # 后台任务
    │   └── utils/    # 工具函数
    └── migrations/   # 数据库迁移文件
```

## 下一步

项目启动成功后，你可以：
1. 浏览和测试现有功能
2. 查看代码结构和实现
3. 继续开发剩余功能
4. 进行功能测试和优化

## 常见问题解决

### 后端问题

#### 1. libmagic 库缺失错误
```
ImportError: failed to find libmagic. Check your installation
```
**解决方案**: 
- 已自动修复，使用Windows兼容的`python-magic-bin`
- 重新运行`start_backend.bat`即可

#### 2. Flask-Migrate命令不可用
```
Error: No such command 'db'
```
**解决方案**:
- 确保Flask-Migrate正确安装
- 检查FLASK_APP环境变量设置
- 重新安装依赖

#### 3. 数据库连接失败
**解决方案**:
- 确认MySQL服务运行
- 检查`.env`文件中的数据库配置
- 确认数据库`food_manager`已创建

### 前端问题

#### 1. 依赖解析错误
**解决方案**:
- 运行`food/reset_and_install.bat`清理重装
- 使用`food/start_web.bat`启动Web版本

#### 2. Expo Go功能限制
- 推送通知在Expo Go中不可用（正常现象）
- 部分原生功能需要开发构建

如果遇到问题，请检查：
1. 所有服务是否正常启动
2. 数据库连接是否正确
3. 端口是否被占用
4. 依赖是否完整安装